---
import Layout from "../layouts/Layout.astro";
import ArrowUp from "../assets/dpad/arrow-up.svg";
import ArrowDown from "../assets/dpad/arrow-down.svg";
import ArrowLeft from "../assets/dpad/arrow-left.svg";
import ArrowRight from "../assets/dpad/arrow-right.svg";
---

<Layout title="Training Protocol - Active">
    <div class="max-w-4xl mx-auto" x-data="stratagemGame()">
        <!-- Game Status Bar -->
        <div
            class="mb-8 bg-terminal-gray/30 border border-terminal-border rounded-lg p-4 backdrop-blur-sm transition-all duration-300"
            :style="errorState ? 'border-color: #ff4444 !important; background-color: rgba(255, 68, 68, 0.2) !important; box-shadow: 0 0 30px rgba(255, 68, 68, 0.8), inset 0 0 30px rgba(255, 68, 68, 0.2);' : ''"
        >
            <div
                class="flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0"
            >
                <div class="flex items-center space-x-4">
                    <span class="text-terminal-amber font-semibold"
                        >STATUS:</span
                    >
                    <span
                        x-text="gameStatus"
                        class="text-terminal-green transition-colors duration-300"
                        :style="errorState ? 'color: #ff4444 !important; text-shadow: 0 0 15px rgba(255, 68, 68, 1), 0 0 30px rgba(255, 68, 68, 0.6);' : ''">READY</span
                    >
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-terminal-amber font-semibold"
                        >SEQUENCE:</span
                    >
                    <span
                        x-text="currentIndex + '/' + (currentStratagem?.sequence?.length || 0)"
                        class="text-terminal-green">0/0</span>
                    <span x-show="errorState" class="text-terminal-red ml-2">[ERROR]</span
                    >
                </div>
            </div>
        </div>

        <!-- Main Game Area -->
        <div
            class="bg-terminal-gray/30 border border-terminal-border rounded-lg p-8 backdrop-blur-sm transition-all duration-300"
            :style="errorState ? 'border-color: #ff4444 !important; background-color: rgba(255, 68, 68, 0.2) !important; box-shadow: 0 0 40px rgba(255, 68, 68, 1), inset 0 0 40px rgba(255, 68, 68, 0.3); animation: shake 0.5s ease-in-out;' : ''"
        >
            <!-- Stratagem Display -->
            <div class="text-center mb-8">
                <div class="mb-4">
                    <div class="mb-2 flex justify-center">
                        <img
                            :src="currentStratagem?.iconUrl || ''"
                            :alt="currentStratagem?.name || 'Loading...'"
                            class="w-20 h-20 object-contain bg-terminal-dark/50 border border-terminal-border rounded p-3 stratagem-icon"
                            x-show="currentStratagem?.iconUrl"
                        />
                        <div
                            x-show="!currentStratagem?.iconUrl"
                            class="w-16 h-16 flex items-center justify-center text-4xl bg-terminal-dark border border-terminal-border rounded"
                        >
                            üéØ
                        </div>
                    </div>
                    <div
                        x-text="currentStratagem?.name || 'Loading...'"
                        class="text-2xl md:text-3xl text-terminal-amber font-bold mb-2"
                    >
                    </div>
                    <div class="text-sm text-terminal-green/70">
                        Enter the sequence using arrow keys
                    </div>
                </div>
            </div>

            <!-- Sequence Display -->
            <div class="mb-8">
                <div class="text-center mb-4">
                    <span class="text-terminal-amber font-semibold"
                        >SEQUENCE:</span
                    >
                </div>
                <div class="flex justify-center flex-wrap gap-2">
                    <template
                        x-for="(key, index) in (currentStratagem?.sequence || [])"
                        :key="index"
                    >
                        <div
                            class="w-12 h-12 border-2 rounded flex items-center justify-center transition-all duration-300 p-2"
                            :class={`{
								'border-terminal-green bg-terminal-green/20': index < currentIndex,
								'border-terminal-amber bg-terminal-amber/10 animate-pulse': index === currentIndex,
								'border-terminal-border bg-terminal-dark': index > currentIndex
							}`}
                        >
                            <template x-if="key === 'up'">
                                <ArrowUp
                                    class="w-full h-full object-contain sequence-arrow"
                                    :class={`{
                                        'filter-green': index < currentIndex,
                                        'filter-amber': index === currentIndex,
                                        'filter-gray': index > currentIndex
                                    }`}
                                />
                            </template>
                            <template x-if="key === 'down'">
                                <ArrowDown
                                    class="w-full h-full object-contain sequence-arrow"
                                    :class={`{
                                        'filter-green': index < currentIndex,
                                        'filter-amber': index === currentIndex,
                                        'filter-gray': index > currentIndex
                                    }`}
                                />
                            </template>
                            <template x-if="key === 'left'">
                                <ArrowLeft
                                    class="w-full h-full object-contain sequence-arrow"
                                    :class={`{
                                        'filter-green': index < currentIndex,
                                        'filter-amber': index === currentIndex,
                                        'filter-gray': index > currentIndex
                                    }`}
                                />
                            </template>
                            <template x-if="key === 'right'">
                                <ArrowRight
                                    class="w-full h-full object-contain sequence-arrow"
                                    :class={`{
                                        'filter-green': index < currentIndex,
                                        'filter-amber': index === currentIndex,
                                        'filter-gray': index > currentIndex
                                    }`}
                                />
                            </template>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Virtual Arrow Keys (for visual reference) -->
            <div class="mb-8">
                <div class="text-center mb-4">
                    <span class="text-terminal-amber font-semibold"
                        >CONTROLS:</span
                    >
                </div>
                <div class="flex justify-center">
                    <div class="grid grid-cols-3 gap-2 w-48">
                        <div></div>
                        <button
                            @click="handleKeyPress('up')"
                            class="key-display bg-terminal-dark border-2 border-terminal-border p-3 rounded hover:border-terminal-green transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center"
                            :class="{ 'bg-terminal-green scale-110': pressedKey === 'up' }"
                        >
                            <ArrowUp
                                class="w-6 h-6 object-contain control-arrow"
                                :class="{ 'filter-dark': pressedKey === 'up', 'filter-green': pressedKey !== 'up' }"
                            />
                        </button>
                        <div></div>
                        <button
                            @click="handleKeyPress('left')"
                            class="key-display bg-terminal-dark border-2 border-terminal-border p-3 rounded hover:border-terminal-green transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center"
                            :class="{ 'bg-terminal-green scale-110': pressedKey === 'left' }"
                        >
                            <ArrowLeft
                                class="w-6 h-6 object-contain control-arrow"
                                :class="{ 'filter-dark': pressedKey === 'left', 'filter-green': pressedKey !== 'left' }"
                            />
                        </button>
                        <button
                            @click="handleKeyPress('down')"
                            class="key-display bg-terminal-dark border-2 border-terminal-border p-3 rounded hover:border-terminal-green transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center"
                            :class="{ 'bg-terminal-green scale-110': pressedKey === 'down' }"
                        >
                            <ArrowDown
                                class="w-6 h-6 object-contain control-arrow"
                                :class="{ 'filter-dark': pressedKey === 'down', 'filter-green': pressedKey !== 'down' }"
                            />
                        </button>
                        <button
                            @click="handleKeyPress('right')"
                            class="key-display bg-terminal-dark border-2 border-terminal-border p-3 rounded hover:border-terminal-green transition-all duration-200 hover:scale-105 active:scale-95 flex items-center justify-center"
                            :class="{ 'bg-terminal-green scale-110': pressedKey === 'right' }"
                        >
                            <ArrowRight
                                class="w-6 h-6 object-contain control-arrow"
                                :class="{ 'filter-dark': pressedKey === 'right', 'filter-green': pressedKey !== 'right' }"
                            />
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Messages -->
            <div
                class="text-center p-4 bg-terminal-dark/50 border border-terminal-border rounded min-h-[60px] flex items-center justify-center transition-all duration-300"
                :style="errorState ? 'border-color: #ff4444 !important; background-color: rgba(255, 68, 68, 0.3) !important; box-shadow: 0 0 50px rgba(255, 68, 68, 1), inset 0 0 50px rgba(255, 68, 68, 0.4);' : ''"
            >
                <span x-html="gameMessage" class="text-terminal-green"></span>
            </div>

            <!-- Restart Button -->
            <div class="text-center mt-6">
                <button
                    @click="initGame()"
                    class="px-6 py-2 bg-terminal-dark border border-terminal-border text-terminal-green hover:border-terminal-amber hover:text-terminal-amber transition-colors rounded font-mono"
                >
                    &gt; RESTART PROTOCOL
                </button>
            </div>
        </div>
    </div>
</Layout>

<script>
    import {
        stratagems,
        getRandomStratagem,
        getKeySymbol,
    } from "../data/stratagems.ts";

    // Alpine.js component
    document.addEventListener("alpine:init", () => {
        Alpine.data("stratagemGame", () => ({
            currentStratagem: null,
            currentIndex: 0,
            gameActive: false,
            gameStatus: "READY",
            gameMessage: "Press any arrow key to begin training...",
            pressedKey: null,
            errorState: false,

            init() {
                this.initGame();

                // Keyboard event listener
                this.$nextTick(() => {
                    document.addEventListener("keydown", (e) => {
                        let key = "";
                        switch (e.code) {
                            case "ArrowUp":
                                key = "up";
                                break;
                            case "KeyW":
                                key = "up";
                                break;
                            case "ArrowDown":
                                key = "down";
                                break;
                            case "KeyS":
                                key = "down";
                                break;
                            case "ArrowLeft":
                                key = "left";
                                break;
                            case "KeyA":
                                key = "left";
                                break;
                            case "ArrowRight":
                                key = "right";
                                break;
                            case "KeyD":
                                key = "right";
                                break;
                            default:
                                return;
                        }

                        e.preventDefault();
                        this.handleKeyPress(key);
                    });
                });
            },

            initGame() {
                this.currentStratagem = getRandomStratagem();
                this.currentIndex = 0;
                this.gameActive = true;
                this.gameStatus = "ACTIVE";
                this.gameMessage = "Enter the sequence using arrow keys";
                this.errorState = false;
            },

            handleKeyPress(key) {
                if (!this.gameActive || !this.currentStratagem) return;

                const expectedKey =
                    this.currentStratagem.sequence[this.currentIndex];

                // Visual feedback for pressed key
                this.pressedKey = key;
                setTimeout(() => {
                    this.pressedKey = null;
                }, 200);

                if (key === expectedKey) {
                    // Correct key
                    this.currentIndex++;

                    if (
                        this.currentIndex >=
                        this.currentStratagem.sequence.length
                    ) {
                        // Sequence completed
                        this.gameActive = false;
                        this.gameMessage =
                            '<span class="text-terminal-green">‚úÖ SEQUENCE COMPLETED! Excellent work, Helldiver!</span>';
                        this.gameStatus = "COMPLETED";
                        setTimeout(() => {
                            this.initGame(); // Start new round
                        }, 2000);
                    } else {
                        this.gameMessage = `<span class="text-terminal-green">Correct! Continue sequence... (${this.currentIndex}/${this.currentStratagem.sequence.length})</span>`;
                    }
                } else {
                    // Wrong key - trigger error state
                    console.log('Error triggered! Setting errorState to true');
                    this.gameActive = false;
                    this.errorState = true;
                    this.gameMessage = `<span class="text-terminal-red">‚ùå INCORRECT SEQUENCE! Expected ${this.getKeySymbol(expectedKey)}, got ${this.getKeySymbol(key)}. Restarting...</span>`;
                    this.gameStatus = "FAILED";

                    // Clear error state after animation
                    setTimeout(() => {
                        console.log('Clearing error state');
                        this.errorState = false;
                    }, 500);

                    setTimeout(() => {
                        this.initGame(); // Restart
                    }, 2000);
                }
            },

            getKeySymbol(key) {
                return getKeySymbol(key);
            },
        }));
    });
</script>

<style>
    /* Additional game-specific styles */
    .key-display {
        transition: all 0.2s ease;
    }

    .key-display:hover {
        transform: scale(1.05);
    }

    .key-display:active {
        transform: scale(0.95);
    }

    .stratagem-icon {
        filter: brightness(1.2) contrast(1.1) hue-rotate(8deg);
        transition: all 0.3s ease;
    }

    .stratagem-icon:hover {
        filter: brightness(1.4) contrast(1.2) hue-rotate(8deg);
        transform: scale(1.05);
    }

    /* Arrow filter classes */
    .filter-green {
        filter: brightness(0) saturate(100%) invert(66%) sepia(73%)
            saturate(578%) hue-rotate(8deg) brightness(101%) contrast(101%);
    }

    .filter-amber {
        filter: brightness(0) saturate(100%) invert(87%) sepia(69%)
            saturate(2834%) hue-rotate(3deg) brightness(101%) contrast(101%);
    }

    .filter-gray {
        filter: brightness(0) saturate(100%) invert(50%) sepia(0%) saturate(0%)
            hue-rotate(0deg) brightness(50%) contrast(100%);
    }

    .filter-dark {
        filter: brightness(0) saturate(100%) invert(8%) sepia(7%)
            saturate(1077%) hue-rotate(169deg) brightness(96%) contrast(91%);
    }

    .sequence-arrow,
    .control-arrow {
        transition: filter 0.2s ease;
    }
</style>
